{% extends "base.html" %}

{% block title %}Buscador de t√©rminos ‚Äì Proyecto BigData{% endblock %}

{% block content %}
<main class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">

            <h1 class="mb-2">Buscador de t√©rminos</h1>
            <p class="text-muted mb-4">
                Escribe una palabra clave para buscar en el √≠ndice de lenguaje controlado
                de la Secretar√≠a de la Mujer (normas, lineamientos, portafolios, etc.).
            </p>

            <!-- Formulario de b√∫squeda -->
           <form id="form-busqueda" class="mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-md-6">
            <label for="query" class="form-label">T√©rmino de b√∫squeda</label>
            <input type="text"
                   class="form-control"
                   id="query"
                   name="q"
                   placeholder="Ej.: violencia, cuidado, salud mental‚Ä¶"
                   required>
        </div>

        <!-- NUEVO: filtro por tipo de t√©rmino -->
        <div class="col-md-3">
            <label for="tipo_termino" class="form-label">Tipo de t√©rmino</label>
            <select id="tipo_termino" name="tipo_termino" class="form-select">
                <option value="">Todos</option>
                <option value="padre">Solo t√©rminos padre</option>
                <option value="hijo">Solo t√©rminos hijo</option>
            </select>
        </div>

        <div class="col-md-3 d-grid">
            <button type="submit" class="btn btn-primary mt-md-0 mt-3">
                Buscar t√©rminos
            </button>
        </div>
    </div>
</form>


            <!-- Mensajes -->
            <div id="alerta" class="alert alert-info d-none">
                Escribe un t√©rmino y presiona <strong>Buscar</strong> para ver resultados.
            </div>

            <!-- Spinner de carga -->
            <div id="cargando" class="text-center my-4 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando‚Ä¶</span>
                </div>
                <p class="mt-2 mb-0 text-muted">
                    Consultando el √≠ndice en ElasticSearch‚Ä¶
                </p>
            </div>

            <!-- Resultados -->
            <div id="resultados" class="mt-4"></div>

        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
const form = document.getElementById('form-busqueda');
const resultadosDiv = document.getElementById('resultados');
const cargandoDiv = document.getElementById('cargando');
const alertaDiv = document.getElementById('alerta');

function mostrarMensaje(tipo, mensajeHtml) {
    resultadosDiv.innerHTML = '';
    alertaDiv.className = 'alert alert-' + tipo;
    alertaDiv.innerHTML = mensajeHtml;
    alertaDiv.classList.remove('d-none');
}

form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const q = document.getElementById('query').value.trim();
    const tipo = document.getElementById('tipo_termino').value;  // üëà NUEVO

    if (!q) {
        mostrarMensaje('warning', 'Por favor escribe un t√©rmino de b√∫squeda.');
        return;
    }

    alertaDiv.classList.add('d-none');
    resultadosDiv.innerHTML = '';
    cargandoDiv.classList.remove('d-none');

    try {
        const params = new URLSearchParams({
            q: q,
            tipo: tipo   // üëà mandamos el tipo al backend
        });

        const url = `/api/buscar?${params.toString()}`;
        const resp = await fetch(url);
        const data = await resp.json();

        cargandoDiv.classList.add('d-none');

        if (!resp.ok) {
            mostrarMensaje('danger', data.error || 'Error en la b√∫squeda.');
            return;
        }

        const hits = (data.hits && data.hits.hits) ? data.hits.hits : [];

        if (!hits.length) {
            mostrarMensaje(
                'info',
                'No se encontraron resultados para <strong>"' + q + '"</strong>.'
            );
            return;
        }

        let html = `
            <h2 class="h5 mb-3">
                Resultados para <span class="fw-semibold">"${q}"</span>
                <span class="text-muted">(${hits.length})</span>
            </h2>
        `;

        hits.forEach((hit, index) => {
            const score = hit._score !== undefined ? hit._score.toFixed(3) : '';
            const src = hit._source || {};

            const titulo = src.term_child || src.term_parent || 'Sin t√≠tulo';
            const definicion = src.definition || src.definicion_1 || '';
            const fuente = src.fuente_1 || src.fuente || '';
            const urlDoc = src.source_url || src.url || '';

            html += `
            <article class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <h3 class="h6 mb-1">${titulo}</h3>
                    ${score ? `<p class="text-muted small mb-2">Relevancia: ${score}</p>` : ''}

                    ${definicion ? `<p class="mb-2">${definicion}</p>` : ''}

                    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                        ${fuente ? `<span class="badge text-bg-light">Fuente: ${fuente}</span>` : ''}
                        ${urlDoc ? `<a href="${urlDoc}" target="_blank" rel="noopener" class="small">Ver documento fuente</a>` : ''}
                    </div>
                </div>
            </article>
            `;
        });

        resultadosDiv.innerHTML = html;

    } catch (err) {
        console.error(err);
        cargandoDiv.classList.add('d-none');
        mostrarMensaje('danger', 'Error de conexi√≥n con el backend.');
    }
});
</script>
{% endblock %}
